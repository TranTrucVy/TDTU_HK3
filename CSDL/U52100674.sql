USE MASTER
GO
IF EXISTS (SELECT * FROM SYSDATABASES WHERE NAME='U52100674')
BEGIN
	DROP DATABASE U52100674
END 
GO
CREATE DATABASE U52100674
GO
USE U52100674
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='KHOA')
BEGIN
	DROP TABLE KHOA
END 
GO
CREATE TABLE KHOA(
	MAKHOA VARCHAR(255),
	TENKHOA NVARCHAR(255),
	PRIMARY KEY(MAKHOA)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='SINHVIEN')
BEGIN
	DROP TABLE SINHVIEN
END 
GO
CREATE TABLE SINHVIEN(
	MASV VARCHAR(255),
	HOTEN NVARCHAR(255),
	NGAYSINH DATE,
	DIENTHOAI VARCHAR(255) UNIQUE NOT NULL,
	MAKHOA VARCHAR(255),
	PRIMARY KEY(MASV),
	CONSTRAINT FK_KHOA_MK FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='MONHOC')
BEGIN
	DROP TABLE MONHOC
END 
GO
CREATE TABLE MONHOC(
	MAMH VARCHAR(255),
	TENMON NVARCHAR(255),
	TINCHI INT,
	PRIMARY KEY(MAMH)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME='KETQUA')
BEGIN
	DROP TABLE KETQUA
END 
GO
CREATE TABLE KETQUA(
	MASV VARCHAR(255),
	MAMH VARCHAR(255),
	DIEM INT CHECK(DIEM>=0 AND DIEM<=10),
	PRIMARY KEY(MASV,MAMH),
	CONSTRAINT FK_SV_MSSV FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV),
	CONSTRAINT FK_MH_MAMH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)
)
GO
--ALTER TABLE KETQUA
--DROP CONSTRAINT FK_SV_MSSV
--ALTER TABLE KETQUA
--DROP CONSTRAINT FK_MH_MAMH

INSERT INTO KHOA
VALUES
	('CNTT',N'IT'),
	('AV',N'ANH VĂN'),
	('HH',N'HÓA HỌC'),
	('VL',N'VẬT LÝ');
GO
SET DATEFORMAT DMY
GO
INSERT INTO SINHVIEN
VALUES
	('SV01', N'TRẦN VẸN','15/07/2003','0353472138','CNTT'),
	('SV02', N'TRẦN NHẬT','15/07/2000','0353472148','CNTT'),
	('SV03', N'HỒ NHẠC','15/07/1955','0353472158','CNTT'),
	('SV04', N'VÂN DU','15/07/1900','0353472168','HH'),
	('SV05', N'MINH NHẠT','15/07/2000','03534721758','VL');

GO
--INSERT INTO SINHVIEN
--VALUES
--	('SV06', N'AHIHI','14/10/1982','0353572138','CNTT');
--GO
INSERT INTO MONHOC
VALUES
		('DBS',N'CƠ SỞ DỮ LIỆU',2),
		('DSA',N'CTDL VÀ GT',2),
		('DB',N'DỮ LIỆU',5),
		('TH',N'TRIẾT HỌC',1),
		('VLĐC',N'VẬT LÝ ĐẠI CƯƠNG',3);
GO
INSERT INTO KETQUA
VALUES
		('SV01',N'DBS',5),
		('SV02',N'DSA',7),
		('SV02',N'DBS',6),
		('SV04',N'TH',9),
		('SV05',N'VLĐC',8);
GO
--delete from KETQUA where MAMH ='TH'
--delete from MONHOC where MONHOC.MAMH = 'TH'
INSERT INTO KETQUA
VALUES
		('SV01','DSA',7);
GO
INSERT INTO KETQUA
VALUES
		('SV01','DB',7);
GO
SELECT * FROM KHOA
SELECT * FROM SINHVIEN
SELECT * FROM MONHOC
SELECT * FROM KETQUA

SELECT *,YEAR(GETDATE())-YEAR(NGAYSINH) FROM SINHVIEN
WHERE YEAR(GETDATE())-YEAR(NGAYSINH)>40 
AND MASV NOT IN (SELECT DISTINCT KETQUA.MASV FROM SINHVIEN JOIN KETQUA
ON SINHVIEN.MASV = KETQUA.MASV)
GO

SELECT * FROM SINHVIEN LEFT JOIN KETQUA
ON SINHVIEN.MASV = KETQUA.MASV
WHERE KETQUA.MASV IS NULL 
AND YEAR(GETDATE())-YEAR(NGAYSINH)>40

SELECT MAMH, TENMON FROM MONHOC
WHERE TINCHI>=3
AND MAMH IN (
	SELECT MAMH FROM KETQUA
	WHERE MASV IN (
		SELECT MASV FROM SINHVIEN 
		WHERE MAKHOA = N'CNTT'
	)
)
GO
SELECT MONHOC.MAMH,MONHOC.TENMON FROM SINHVIEN 
JOIN KETQUA ON KETQUA.MASV = SINHVIEN.MASV
JOIN MONHOC ON MONHOC.MAMH = KETQUA.MAMH
WHERE MONHOC.TINCHI>=3
AND SINHVIEN.MAKHOA =N'CNTT'

SELECT MAMH FROM MONHOC
WHERE MAMH NOT IN (
	SELECT MAMH FROM KETQUA
	WHERE MASV IN (
		SELECT MASV FROM SINHVIEN 
		WHERE MAKHOA = N'CNTT'
	)
)







