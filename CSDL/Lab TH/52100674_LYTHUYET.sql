USE MASTER
GO
IF EXISTS (SELECT * FROM SYSDATABASES WHERE NAME = 'NGK')
BEGIN
	DROP DATABASE NGK
END
GO
CREATE DATABASE NGK
GO
USE NGK
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='LOAINGK')
BEGIN 
	DROP TABLE LOAINGK
END
CREATE TABLE LOAINGK(
	MALOAI VARCHAR(255),
	TENLOAI VARCHAR(255) UNIQUE NOT NULL,

	PRIMARY KEY(MALOAI)
)
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='NGK')
BEGIN 
	DROP TABLE NGK
END
CREATE TABLE NGK(
	MANGK VARCHAR(255),
	TENNGK VARCHAR(255) UNIQUE NOT NULL,
	DVT NVARCHAR(255) CHECK (DVT IN(N'CHAI',N'LON',N'THÙNG',N'KẾT')),
	SOLUONG INT CHECK (SOLUONG>0),
	DONGIA INT CHECK(DONGIA>0),
	MALOAINGK VARCHAR(255),

	PRIMARY KEY(MANGK),
	FOREIGN KEY(MALOAINGK) REFERENCES LOAINGK(MALOAI)
)
GO
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='KHACHHANG')
BEGIN 
	DROP TABLE KHACHHANG
END
CREATE TABLE KHACHHANG(
	MSKH VARCHAR(255),
	HOTEN NVARCHAR(255),
	DIACHI NVARCHAR(255),
	DIENTHOAI VARCHAR(11) DEFAULT 'CHƯA CÓ',

	PRIMARY KEY(MSKH)
)
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='HOADON')
BEGIN 
	DROP TABLE HOADON
END
CREATE TABLE HOADON(
	SOHD VARCHAR(255),
	MSKH VARCHAR(255),
	NHANVIEN NVARCHAR(255),
	NGAYLAP DATE DEFAULT GETDATE(),

	PRIMARY KEY(SOHD),
	CONSTRAINT FR_HOADON_MSKH FOREIGN KEY(MSKH) REFERENCES KHACHHANG(MSKH)
)
IF EXISTS (SELECT * FROM SYSOBJECTS WHERE NAME ='CTHD')
BEGIN 
	DROP TABLE CTHD
END
CREATE TABLE CTHD(
	SOHD VARCHAR(255),
	MANGK VARCHAR(255),
	SOLUONG INT CHECK (SOLUONG>0),
	DONGIA INT,

	PRIMARY KEY(SOHD, MANGK),
)
--1F
ALTER TABLE CTHD ADD THANHTIEN INT
ALTER TABLE CTHD ADD CONSTRAINT FK_HOADON_SOHD FOREIGN KEY(SOHD) REFERENCES HOADON(SOHD)
ALTER TABLE CTHD ADD CONSTRAINT FK_NGK_MANKG FOREIGN KEY(MANGK) REFERENCES NGK(MANGK)
ALTER TABLE CTHD ADD CONSTRAINT CHECK_DG CHECK(DONGIA>1000)
--1G
ALTER TABLE CTHD DROP CONSTRAINT FK_HOADON_SOHD 
--1H
ALTER TABLE CTHD ADD CONSTRAINT CHECK_TT CHECK(THANHTIEN>0)
--2A

INSERT INTO LOAINGK
VALUES
		('L01','NUOCCOGAS'),
		('L02','NUOCCHUACON'),
		('L03','NUOCTRAICAY');
		
INSERT INTO NGK
VALUES
		('NGK01','COCACOLA','LON',24,2000,'L01'),
		('NGK02','PEPSI','CHAI',25,3000,'L01'),
		('NGK03','BEER','THÙNG',10,20000,'L02'),
		('NGK04','NUOCTAO','LON',10,2000,'L03');
INSERT INTO NGK
VALUES 
		('NGK05','NUOCME','THÙNG',2,450000,'L03');
		
SELECT * FROM NGK
INSERT INTO KHACHHANG
VALUES
		('KH01',N'TRẦN THỊ VẸN',N'TPCHM','0354646433'),
		('KH02',N'TƯỜNG VY',N'HÀ NỘI','0131361636'),
		('KH03',N'MINH NHẬT',N'BÌNH ĐỊNH','0239233274'),
		('KH04',N'LINH VY',N'ĐỒNG NAI','0943274323');

SET DATEFORMAT DMY
INSERT INTO HOADON
VALUES
		('HD01','KH01',N'NGUYỄN VĂN A','15/07/2003'),
		('HD02','KH02',N'NGUYỄN VĂN B','19/06/2000'),
		('HD03','KH01',N'NGUYỄN VĂN C','25/07/2018'),
		('HD04','KH03',N'NGUYỄN VĂN D','15/08/2018'),
		('HD05','KH04',N'NGUYỄN VĂN E','25/07/2020');
select * from hoadon
INSERT INTO CTHD
VALUES
		('HD01','NGK01',2,3000,6000),
		('HD02','NGK02',5,7000,35000),
		('HD03','NGK04',10,8000,80000),
		('HD04','NGK03',2,5000,10000);

